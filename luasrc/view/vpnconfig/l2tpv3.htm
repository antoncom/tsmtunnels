<% --[[=========== JS ==========]] %>
<%+vpnconfig/vpnconfig.js%>

<% --[[=========== LUA BACKEND ==========]] %>
<%
	local vpnType = "l2tpv3"
%>

<div id="view">
    <h2><%:L2TPv3 tunnels %></h2>

	<div id="l2tpv3_rows" class="table">
		<div class="tr table-titles">
			<div class="th">Name</div>
			<div class="th">Active</div>
			<div class="th center nowrap cbi-section-actions"><%:Actions %></div>
		</div>
	</div>
	<div class="cbi-page-actions">
        <span id="btn_enable_spinner" class="btn_spinner"></span> 
        <input class="cbi-button cbi-button-apply" type="button" value="Create new" onclick="showModal(new L2ptv3Data())"> 
    </div>
</div>


<script type="text/javascript">

	class L2ptv3Data {
		name = "";
		type = '<%=vpnType%>';
		isActive = false;
		options = {
			localAddr: "",
			remoteAddr: "",
			bridge: "",
			zone: "",
			tunnelIp: "",
			tunnelMask: "",
			tunnelId: "0",
			remoteTunnelId: "",
			sessionId: "0",
			remoteSessionId: "",
			encapsulation: "ip",
			l2HeaderType: "none",
		};
	}
	
	var localAddresses = [];
	var firewallZones = [];
	var bridges = [];
	var encapsulationTypes = ["ip"];
	var l2HeaderTypes = ["none"];

	get_list_firewall_zone(function(list){
		firewallZones = list;
	});

	get_list_bridges(function(list){
		bridges = list;
	});

	get_list_interfaces(function(list){
		localAddresses = list;
	});
	
	get_cfg_data('<%=vpnType%>', function(sections) {
		for (s in sections) {
			var l2ptv3Data = new L2ptv3Data();
			l2ptv3Data.name = sections[s]['.name'];
			l2ptv3Data.isActive = parse_bool(sections[s]['isActive']);

			l2ptv3Data.options['localAddr'] = sections[s]['localAddr'];
			l2ptv3Data.options['remoteAddr'] = sections[s]['remoteAddr'];
			l2ptv3Data.options['bridge'] = sections[s]['bridge'];
			l2ptv3Data.options['zone'] = sections[s]['zone'];
			l2ptv3Data.options['tunnelIp'] = sections[s]['tunnelIp'];
			l2ptv3Data.options['tunnelMask'] = sections[s]['tunnelMask'];
			l2ptv3Data.options['tunnelId'] = sections[s]['tunnelId'];
			l2ptv3Data.options['remoteTunnelId'] = sections[s]['remoteTunnelId'];
			l2ptv3Data.options['sessionId'] = sections[s]['sessionId'];
			l2ptv3Data.options['remoteSessionId'] = sections[s]['remoteSessionId'];
			l2ptv3Data.options['encapsulation'] = sections[s]['encapsulation'];
			l2ptv3Data.options['l2HeaderType'] = sections[s]['isNotCachel2HeaderType'];
				
			addRow('l2tpv3_rows', l2ptv3Data);
		}
	});
	
	function showModal(l2ptv3Data) {
		L.require('ui').then(function(ui) {
			var form = {
				name: new ui.Textfield(l2ptv3Data.name, {
					placeholder: "Name",
					optional: false,
					readonly: l2ptv3Data.name.length > 0,
					validate: nearleyValidator('sectionName', 'Should contain letters, numbers and "_"')
				}),		
				localAddr: new ui.Dropdown(l2ptv3Data.options.localAddr, make_dropdown_options(localAddresses), {
					multiple: false,
					optional: false
				}),		
				remoteAddr: new ui.Textfield(l2ptv3Data.options.remoteAddr, {
					placeholder: "Remote IP",
					optional: false,
					validate: nearleyValidator('ip4', 'Should contain numbers 0..255 and "."')
				}),
				bridge: new ui.Dropdown(l2ptv3Data.options.bridge, make_dropdown_options(bridges), {
					multiple: false,
					optional: false,
					create: false,
				}),		
				zone: new ui.Dropdown(l2ptv3Data.options.zone, make_dropdown_options(firewallZones), {
					multiple: false,
					create: false,
					optional: false
				}),		
				tunnelIp: new ui.Textfield(l2ptv3Data.options.tunnelIp, {
					optional: false,
					placeholder: "Local IP for tunnel",
					validate: nearleyValidator('ip4', 'Should contain numbers 0..255 and "."')
				}),		
				tunnelMask: new ui.Textfield(l2ptv3Data.options.tunnelMask, {
					optional: false,
					placeholder: "tunnel netmask",
					validate: nearleyValidator('netmask', 'Should contain numbers 0..255 and "." or bits count 0..32')
				}),				
				tunnelId: new ui.Textfield(l2ptv3Data.options.tunnelId, {
					optional: false,
					placeholder: "",
					validate: nearleyValidator('integer', 'Should contain only digits')
				}),		
				remoteTunnelId: new ui.Textfield(l2ptv3Data.options.remoteTunnelId, {
					optional: false,
					placeholder: "",
					validate: nearleyValidator('integer', 'Should contain only digits')
				}),		
				sessionId: new ui.Textfield(l2ptv3Data.options.sessionId, {
					optional: false,
					placeholder: "",
					validate: nearleyValidator('integer', 'Should contain only digits')
				}),		
				remoteSessionId: new ui.Textfield(l2ptv3Data.options.remoteSessionId, {
					optional: true,
					placeholder: "",
					validate: nearleyValidator('integer', 'Should contain only digits')
				}),		
				encapsulation: new ui.Dropdown(l2ptv3Data.options.encapsulation, make_dropdown_options(encapsulationTypes), {
					multiple: false,
					optional: false
				}),		
				l2HeaderType: new ui.Dropdown(l2ptv3Data.options.l2HeaderType, make_dropdown_options(l2HeaderTypes), {
					multiple: false,
					optional: false
				})
			}
	
			L.showModal('Configure L2TPv3 tunnel', [
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Name %>')),
					E('div', { class: 'cbi-value-field' }, [form.name.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Local address %>')),
					E('div', { class: 'cbi-value-field' }, [form.localAddr.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Remote address %>')),
					E('div', { class: 'cbi-value-field' }, [form.remoteAddr.render()])
				]),

				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Add to bridge or Create new %>')),
					E('div', { class: 'cbi-value-field' }, [form.bridge.render()])
				]),

				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Firewall zone %>')),
					E('div', { class: 'cbi-value-field' }, [form.zone.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Tunnel IP %>')),
					E('div', { class: 'cbi-value-field' }, [form.tunnelIp.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Tunnel netmask %>')),
					E('div', { class: 'cbi-value-field' }, [form.tunnelMask.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Tunnel ID %>')),
					E('div', { class: 'cbi-value-field' }, [form.tunnelId.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Remote tunnel ID %>')),
					E('div', { class: 'cbi-value-field' }, [form.remoteTunnelId.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Session ID %>')),
					E('div', { class: 'cbi-value-field' }, [form.sessionId.render()])
				]),

				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Remote Session ID %>')),
					E('div', { class: 'cbi-value-field' }, [form.remoteSessionId.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:Encapsulation %>')),
					E('div', { class: 'cbi-value-field' }, [form.encapsulation.render()])
				]),
	
				E('div', { class: 'cbi-value' }, [
					E('label', { 'class': 'cbi-value-title' }, _('<%:L2 Specific Header type %>')),
					E('div', { class: 'cbi-value-field' }, [form.l2HeaderType.render()])
				]),
	
				E('div', { class: 'cbi-value-field' }, [
					E('div', {
						class: 'btn',
						click: function() {
							L.hideModal()
						}
					}, _('Close')),
					' ',
					E('div', {
						class: 'btn primary cbi-button',
						click: function() {
							var isFormValid = true;
							for (i in form) {
								var field = form[i];
								field.triggerValidation();
								isFormValid &= field.isValid();
							}

							if (!isFormValid)
								return;
							
							l2ptv3Data.name = form.name.getValue(); 
							l2ptv3Data.options['localAddr'] = form.localAddr.getValue(); 
							l2ptv3Data.options['remoteAddr'] = form.remoteAddr.getValue();
							l2ptv3Data.options['bridge'] = form.bridge.getValue(); 
							l2ptv3Data.options['zone'] = form.zone.getValue(); 
							l2ptv3Data.options['tunnelIp'] = form.tunnelIp.getValue(); 
							l2ptv3Data.options['tunnelMask'] = form.tunnelMask.getValue(); 
							l2ptv3Data.options['tunnelId'] = form.tunnelId.getValue(); 
							l2ptv3Data.options['remoteTunnelId'] = form.remoteTunnelId.getValue(); 
							l2ptv3Data.options['sessionId'] = form.sessionId.getValue(); 
							l2ptv3Data.options['remoteSessionId'] = form.remoteSessionId.getValue();
							l2ptv3Data.options['encapsulation'] = form.encapsulation.getValue();
							l2ptv3Data.options['l2HeaderType'] = form.l2HeaderType.getValue();
	
							commitConfig(l2ptv3Data);
							L.hideModal()
						}
					}, _('Save')),
				]),
			]);
		});
	}
	
</script>